<head runat="server">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="author" content="Mr.H">
	<title>指頭判斷器</title>
	<style>	
		body{	
			
			background: url( "data/b1.jpg" ) left top;
			background-repeat: repeat;			
			background-attachment:fixed;
			font-family:FangSong,Microsoft JhengHei,sans-serif;
		}
		canvas{
			border:1px solid #000000;
		}
	</style>
</head>
<h1>指頭判斷器</h1>
<h2 style='color:red'>請先選擇輸入圖片</h2>
<input accept="image/*" id="uploadImage" type="file" >
<button><a id="downloadLnk" download="output.bmp">下載輸出圖片</a></button>
<hr>
<table>
	<tr>
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業2</h3>
				<button id='gray'>灰階化</button><br/><br/>
				<button id='HOG'>HOG</button>
			</div>
		</td>
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業3</h3>
				variance:<br>
				<input type="text" id="variance" value='1'><br><br>
				<button id='gaussian_noise'>高斯白雜訊</button><br/><br/>
				<button id='gHOG'>高斯白雜訊直方圖</button>
			</div>
		</td>
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業4</h3>
				<button id='RGBTransform'>RGB色彩空間</button><br/><br/>
				<button id='CMYKTransform'>CMYK色彩空間</button><br/><br/>
			</div>
		</td>		
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業5</h3>
				<button id='FTransform'>Fourier Transform</button><br/><br/>
			</div>
		</td>		

		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業6</h3>
				<button id='extractSkin'>Extract Skin</button><br/><br/>
			</div>
		</td>
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業7</h3>
				<button id='equalization'>Histogram Equalization</button><br/><br/>
				<button id='equalizationHOG'>HOG</button><br/><br/>
			</div>
		</td>
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>作業8</h3>
				<button id='edge'>Image smoothing and edge detection</button><br/><br/>
				<select id='mask'>
					<option value="E1">Edge detection 1</option>
					<option value="E2">Edge detection 2</option>
					<option value="E3">Edge detection 3</option>
					<option value="S1">Box smoothing</option>
					<option value="S2">Gaussian smoothing</option>
				</select>
			</div>
		</td>		
		
		<td valign="top">
			<div style='display:inline-block;margin-right:20px'>
				<h3>專題</h3>
				<button id='gesture'>hand Gesture</button><br/><br/>
			</div>
		</td>		
		
	</tr>
</table>
</br></br>
<div>
	<div style="display:inline-block">
		<h2>輸入</h2>
		<canvas id='input' ></canvas>
	</div>
	<div id='outputdiv' style="display:inline-block">
		<h2>輸出</h2>
		<canvas id='output' ></canvas>
	</div>
	<div id='processingdiv' style="display:inline-block">
		<h2>processing</h2>
		<canvas id='processing'></canvas>
	</div>
	<div id='wavediv' style="display:inline-block">
		<h2>wave</h2>
		<canvas id='wave'></canvas>		
	</div>	
</div>
<script src="data/jquery-3.1.0.min.js"></script>
<script src="data/Chart.min.js"></script>
<script src="data/fourierimage.js"></script>
<script>
	
	var c;
	var r;
	var img;
	var imgW, imgH;
	var gaussianEnergy = 50;
	window.onload = function(){
		//init
		var canvas = document.getElementById("input");
		var ctx = canvas.getContext("2d");
		ctx.font = "30px Arial";
		ctx.fillText("未輸入圖像",75,80);
		var canvas = document.getElementById("output");
		var ctx = canvas.getContext("2d");
		ctx.font = "30px Arial";
		ctx.fillText("未輸入圖像",75,80);	
		
		function initOutput(imgW,imgH){
			$('#output').remove();
			$('#outputdiv').append("<canvas id='output' ></canvas>");
			$('#output').attr('width',imgW);
			$('#output').attr('height',imgH);	
		}

		function initWave(imgW,imgH){
			$('#wave').remove();
			$('#wavediv').append("<canvas id='wave' ></canvas>");
			$('#wave').attr('width',imgW);
			$('#wave').attr('height',imgH);	
		}

		function initProcessing(imgW,imgH){
			$('#processing').remove();
			$('#processingdiv').append("<canvas id='processing' ></canvas>");
			$('#processing').attr('width',imgW);
			$('#processing').attr('height',imgH);	
		}		
		
		
		$('#processingdiv').hide();
		$('#wavediv').hide();
		$('button').click(function(){
			$('#processingdiv').hide();
			$('#wavediv').hide();
		});
	
		//輸出
		function download() {
			var canvas = document.getElementById('output');
			var dt = canvas.toDataURL('image/bmp');
			this.href = dt;
		};
		downloadLnk.addEventListener('click', download, false);	

		//灰階
		$('#gray').click(function(){
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					r.data[k] = temp;
					r.data[k+1] = temp;
					r.data[k+2] = temp;
					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);			
		});
		
		//HOG
		$('#HOG').click(function(){
			initOutput(700,500);
			var hog = [];
			var label=[];
			color = [];
			label[0]=0;
			label[255]=255;
			for(var i=0;i<256;i++){
				color[i] = 'rgba(0, 0, 0, 1)';
				hog[i]=0;
			}
			var s = c.getImageData(0,0,imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					hog[Math.floor(temp)]+=1;
				}
			}
			var data = {
				labels: label,
				datasets: [
					{
						label: "Histogram",
						backgroundColor: color,
						data: hog,
					}
				]
			};
			var m = document.getElementById('output');
			ctx= m.getContext('2d');			
			var myBarChart = new Chart(ctx, {
				type: 'bar',
				data: data
			});
			$('#output').css('display','');
		});
		
		//Gaussian noise
		function gaussian(x,mean,variance){
			return (1/Math.sqrt(2*Math.PI*variance))*Math.exp(-Math.pow(x-mean,2)/(2*variance));
		}
		function gaussianNoise(variance){
			if(typeof variance === "undefined") variance = 1.0;

			var rand1 = Math.random();
			rand1 = -2 * Math.log(rand1);

			var rand2 = Math.random();
			rand2 = 2 * Math.PI * rand2;
			return Math.sqrt(rand1 * variance) * Math.cos(rand2);
			 
		}

		$('#gaussian_noise').click(function(){	
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
					var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					noise = gaussianNoise(parseFloat($('#variance').val()));
					r.data[k] = gaussianEnergy*noise+temp;
					r.data[k+1] = gaussianEnergy*noise+temp;
					r.data[k+2] = gaussianEnergy*noise+temp;
					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);
		});
		
		//gHOG
		$('#gHOG').click(function(){
			initOutput(700,500);
			var hog = [];
			var label=[];
			color = [];
			label[0]=-1;
			label[200]=1;
			for(var i=0;i<200;i++){
				color[i] = 'rgba(0, 0, 0, 1)';
				hog[i]=0;
			}
			for(var i=0;i<imgH*imgW;i++){
				noise = gaussianNoise(parseFloat($('#variance').val()));
				hog[Math.floor(noise*100)+100]+=1;
			}
			for(var i=0;i<200;i++){
				hog[i]=hog[i]/(imgH*imgW);
			}
			var data = {
				labels: label,
				datasets: [
					{
						label: "Histogram",
						backgroundColor: color,
						data: hog,
					}
				]
			};
			var m = document.getElementById('output');
			ctx= m.getContext('2d');			
			var myBarChart = new Chart(ctx, {
				type: 'bar',
				data: data
			});
			$('#output').css('display','');
		});

		//RGBTransform
		$('#RGBTransform').click(function(){	
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r=[]
			r[0] = d.createImageData(imgW/2,imgH/2);
			r[1] = d.createImageData(imgW/2,imgH/2);
			r[2] = d.createImageData(imgW/2,imgH/2);
			r[3] = d.createImageData(imgW/2,imgH/2);
			var k = 0;
			for(var i=0;i<imgH;i+=2){
				for(var j=0;j<imgW;j+=2){
					var l = (imgW*i+j)*4;
					temp = (s.data[l]+s.data[l+1]+s.data[l+2])/3
					r[0].data[k] = temp;
					r[0].data[k+1] = temp;
					r[0].data[k+2] = temp;
					r[0].data[k+3] = 255;
					r[1].data[k] = s.data[l];
					r[1].data[k+1] = s.data[l];
					r[1].data[k+2] = s.data[l];
					r[1].data[k+3] = 255;
					r[2].data[k] = s.data[l+1];
					r[2].data[k+1] = s.data[l+1];
					r[2].data[k+2] = s.data[l+1];
					r[2].data[k+3] = 255;
					r[3].data[k] = s.data[l+2];
					r[3].data[k+1] = s.data[l+2];
					r[3].data[k+2] = s.data[l+2];
					r[3].data[k+3] = 255;					
					k+=4;
				}
			}
			d.putImageData(r[0],0,0);
			d.putImageData(r[1],imgW/2,0);
			d.putImageData(r[2],0,imgH/2);
			d.putImageData(r[3],imgW/2,imgH/2);
		});
		
		//CMYKTransform
		$('#CMYKTransform').click(function(){	
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r=[]
			r[0] = d.createImageData(imgW/2,imgH/2);
			r[1] = d.createImageData(imgW/2,imgH/2);
			r[2] = d.createImageData(imgW/2,imgH/2);
			r[3] = d.createImageData(imgW/2,imgH/2);
			var k = 0;
			for(var i=0;i<imgH;i+=2){
				for(var j=0;j<imgW;j+=2){
					var l = (imgW*i+j)*4;
					Rp = s.data[l]/255;
					Gp = s.data[l+1]/255;
					Bp = s.data[l+2]/255;
					K = 1 - Math.max(Rp,Gp,Bp);
					C = (1-Rp-K)/(1-K);
					M = (1-Gp-K)/(1-K);
					Y = (1-Bp-K)/(1-K);
					temp = (C+M+Y)/3*255;
					r[0].data[k] = temp;
					r[0].data[k+1] = temp;
					r[0].data[k+2] = temp;
					r[0].data[k+3] = 255;
					r[1].data[k] = C*255;
					r[1].data[k+1] = C*255;
					r[1].data[k+2] = C*255;
					r[1].data[k+3] = 255;
					r[2].data[k] = M*255;
					r[2].data[k+1] = M*255;
					r[2].data[k+2] = M*255;
					r[2].data[k+3] = 255;
					r[3].data[k] = Y*255;
					r[3].data[k+1] = Y*255;
					r[3].data[k+2] = Y*255;
					r[3].data[k+3] = 255;					
					k+=4;
				}
			}
			d.putImageData(r[0],0,0);
			d.putImageData(r[1],imgW/2,0);
			d.putImageData(r[2],0,imgH/2);
			d.putImageData(r[3],imgW/2,imgH/2);
		});

		//膚色偵測
		$('#extractSkin').click(function(){
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					R = s.data[k];
					G = s.data[k+1];
					B = s.data[k+2];
					Cr = 0.5000*R - 0.4187*G - 0.0813*B + 128 ;
					if(Cr>=140 && Cr<=160){
						r.data[k] = 255;
						r.data[k+1] = 255;
						r.data[k+2] = 255;						
					}
					else{
						r.data[k] = 0;
						r.data[k+1] = 0;
						r.data[k+2] = 0;					
					}

					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);			
		});
		
		//histogram equalization image
		$('#equalization').click(function(){
			initOutput(imgW,imgH);
			var hog = [];
			var label=[];
			for(var i=0;i<256;i++){
				hog[i]=0;
			}
			var s = c.getImageData(0,0,imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					hog[Math.floor(temp)]+=1;
				}
			}
			cdf=[];
			cdf[0]=hog[0];
			hv = [];
			min=0;
			for(var i=1;i<256;i++){
				cdf[i] = cdf[i-1]+hog[i];
				if(cdf[i]!=0 && min==0)min=cdf[i];
				hv[i] = Math.round(((cdf[i]-min)/(imgH*imgW))*255)
			}
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = Math.floor((s.data[k]+s.data[k+1]+s.data[k+2])/3)
					r.data[k] = hv[temp];
					r.data[k+1] = hv[temp];
					r.data[k+2] = hv[temp];
					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);
		});
		//histogram equalization hog
		$('#equalizationHOG').click(function(){
			initOutput(700,500);
			var hog = [];
			var label=[];
			color = [];
			label[0]=0;
			label[255]=255;
			for(var i=0;i<256;i++){
				color[i] = 'rgba(0, 0, 0, 1)';
				hog[i]=0;
			}
			var s = c.getImageData(0,0,imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					hog[Math.floor(temp)]+=1;
				}
			}
			cdf=[];
			cdf[0]=hog[0];
			hv = [];
			min=0;
			for(var i=1;i<256;i++){
				cdf[i] = cdf[i-1]+hog[i];
				if(cdf[i]!=0 && min==0)min=cdf[i];
				hv[i] = Math.round(((cdf[i]-min)/(imgH*imgW))*255)
			}
			newhog = [];
			for(var i=0;i<256;i++){
				newhog[i]=0;
			}
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = Math.floor((s.data[k]+s.data[k+1]+s.data[k+2])/3)
					newhog[hv[temp]]+=1;
				}
			}			
			var data = {
				labels: label,
				datasets: [
					{
						label: "Histogram",
						backgroundColor: color,
						data: newhog,
					}
				]
			};
			var m = document.getElementById('output');
			ctx= m.getContext('2d');			
			var myBarChart = new Chart(ctx, {
				type: 'bar',
				data: data
			});
			$('#output').css('display','');		
		});
		
		//edge detection
		$('#edge').click(function(){
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			imageMatrix = Array(imgH+2);
			new_imageMatrix = Array(imgH+2);
			for(var i=0;i<imgH+2;i++){
				imageMatrix[i] = Array(imgW+2);
				new_imageMatrix[i] = Array(imgW+2);
				for (j=0;j<imgW+2;j++){
					imageMatrix[i][j]=0;
					new_imageMatrix[i][j]=0;
				}
			}
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
					var k = (imgW*i+j)*4;
					imageMatrix[i+1][j+1] = (s.data[k]+s.data[k+1]+s.data[k+2])/3;
				}
			}
			var mask=[];
			switch($('#mask').val()) {
				case 'E1':
					mask = [
					[1,0,-1],
					[0,0,0],
					[-1,0,1]
					];					
					break;
				case 'E2':
					mask = [
					[0,1,0],
					[1,-4,1],
					[0,1,0]
					];
					break;
				case 'E3':
					mask = [
					[-1,-1,-1],
					[-1,8,-1],
					[-1,-1,-1]
					];
					break;
				case 'S1':
					mask = [
					[1/9,1/9,1/9],
					[1/9,1/9,1/9],
					[1/9,1/9,1/9]
					];
					break;
				case 'S2':
					mask = [
					[1/16,2/16,1/16],
					[2/16,4/16,2/16],
					[1/16,2/16,1/16]
					];	
					break;
				default:
					break;
			}					
			for(var i=1;i<=imgH;i++){
				for(var j=1;j<=imgW;j++){
					for(var k=-1;k<=1;k++){
						for(var l=-1;l<=1;l++){
							new_imageMatrix[i][j] += imageMatrix[i+k][j+l]*mask[k+1][l+1];
						}
					}
				}
			}
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
					var k = (imgW*i+j)*4;
					temp=new_imageMatrix[i+1][j+1];
					r.data[k] = temp;
					r.data[k+1] = temp;
					r.data[k+2] = temp;
					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);
		});
		//smoothing
		$('#gray').click(function(){
			initOutput(imgW,imgH);
			var m = document.getElementById('output');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
				var k = (imgW*i+j)*4;
					temp = (s.data[k]+s.data[k+1]+s.data[k+2])/3
					r.data[k] = temp;
					r.data[k+1] = temp;
					r.data[k+2] = temp;
					r.data[k+3] = 255;
				}
			}
			d.putImageData(r,0,0);			
		});		
		
		//手勢數字辨識
		$('#gesture').click(function(){
			$('#processingdiv').show();
			$('#wavediv').show();
			initProcessing(imgW,imgH);
			initOutput(150,150);
			var m = document.getElementById('processing');
			d= m.getContext('2d');
			var s = c.getImageData(0,0,imgW,imgH);
			r = d.createImageData(imgW,imgH);
			skinPoint = []
			for(var i=0;i<imgH;i++){
				for(var j=0;j<imgW;j++){
					var k = (imgW*i+j)*4;
					R = s.data[k];
					G = s.data[k+1];
					B = s.data[k+2];
					Cr = 0.5000*R - 0.4187*G - 0.0813*B + 128 ;
					if(Cr>=140 && Cr<=160){
						r.data[k] = 255;
						r.data[k+1] = 255;
						r.data[k+2] = 255;
						skinPoint.push([i,j])
					}
					else{
						r.data[k] = 0;
						r.data[k+1] = 0;
						r.data[k+2] = 0;				
					}

					r.data[k+3] = 255;
				}
			}
			var center=[0,0];
			for(var i=0;i<skinPoint.length;i++){
				center[0]+=skinPoint[i][0];
				center[1]+=skinPoint[i][1];
			}
			center = [Math.floor(center[0]/skinPoint.length),Math.floor(center[1]/skinPoint.length)];
			for(var i=-10;i<10;i++){
				for(var j=-10;j<10;j++){
					var k = (imgW*(center[0]+i)+center[1]+j)*4;
					r.data[k]=0;
					r.data[k+1]=0;
					r.data[k+2]=255;
				}
			}
			var wave =[];
			var color=[];
			var average=0;
			for(var i=0.1;i<=Math.PI;i+=0.05){
				var temp=[0,0];				
				for(var j=1;j!=0;j++){
					var xbias = Math.round(Math.cos(i)*j);
					var x = center[1]+xbias;
					var ybias = Math.round(Math.sin(i)*j);
					var y = center[0]-ybias;
					if(x>imgW||x<0||y<0) break;
					var k = (imgW*y+x)*4;
					if(r.data[k]==255){
						r.data[k+1]=0
						r.data[k+2]=0
						temp[0]=xbias;
						temp[1]=ybias;
					}
				}
				var dis = Math.sqrt(temp[0]*temp[0]+temp[1]*temp[1]);
				average+=dis;
				if(dis!=0) wave.push(dis);
				color.push('rgba(0, 0, 0, 1)');
				
				//test line and angle
				d.putImageData(r,0,0);
			}
			average /= wave.length;
			wave.splice(0,0,0);
			wave.push(0);
			var mountain = [];
			var cur;
			var last = wave[0];
			var left = wave[0];
			var right;
			var isUp = true;
			var maxHeight;
			for(var i=1;i<wave.length;i++){
				cur = wave[i];
				if(isUp==true && last>cur){
					isUp = false;
					maxHeight = last;
				}
				else if(isUp==false && (last<cur || i==wave.length-1)){
					isUp = true;
					right = last;
					mountain.push(Math.min(maxHeight-left,maxHeight-right));
					left = last;
				}
				last = wave[i];
			}
			
			var predict_number=0;
			for(var i=0;i<mountain.length;i++){
				if(mountain[i]>average/4){
					predict_number+=1;
				}
			}
			
			//show wave
			initWave(700,500);
			var label=[];
			label[0]='0';
			label[wave.length-1]='180';
			var data = {
				labels: label,
				datasets: [
					{
						label: "wave",
						backgroundColor: color,
						data: wave
					},
					{
						label: "average",
						backgroundColor: 'rgba(255, 0, 0, 1)',
						data: [average]
					}
				]
			};
			var m = document.getElementById('wave');
			ctx= m.getContext('2d');		
			var myBarChart = new Chart(ctx, {
				type: 'bar',
				data: data
			});
			$('#wave').css('display','');	
			
			var m1 = document.getElementById('output');
			var ctx1 = m1.getContext("2d");
			ctx1.clearRect(0, 0, m1.width, m1.height);
			ctx1.font = "100px Arial";
			ctx1.fillText(""+predict_number,50,115);
			

		});
		
	}
	
    $("#uploadImage").change(function(){
      readImage( this );
    });
 
    function readImage(input) {
      if ( input.files && input.files[0] ) {
        var FR= new FileReader();
        FR.onload = function(e) {
			var m = document.getElementById('input');
			c = m.getContext('2d');
			img = new Image();
			img.src = e.target.result;
			img.onload = function(){
				imgH = img.height;
				imgW = img.width;
				$('#input').attr('width',imgW)
				$('#input').attr('height',imgH)
				$('#output').attr('width',imgW)
				$('#output').attr('height',imgH)				
				c.drawImage(img,0,0);
			}		  
        };       
        FR.readAsDataURL( input.files[0] );
      }
	  
    }
	
</script>